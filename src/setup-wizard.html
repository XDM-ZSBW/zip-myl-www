<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zip MyL Setup Wizard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            line-height: 1.6;
        }

        .wizard-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .wizard-header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .wizard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .wizard-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .wizard-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3rem;
            position: relative;
        }

        .wizard-progress::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .progress-step.active {
            color: white;
        }

        .progress-step.completed {
            color: #4CAF50;
        }

        .step-number {
            display: block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 auto 0.5rem;
            font-weight: bold;
        }

        .progress-step.active .step-number {
            background: white;
            color: #667eea;
        }

        .progress-step.completed .step-number {
            background: #4CAF50;
            color: white;
        }

        .wizard-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        .wizard-step h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .wizard-step p {
            color: #666;
            margin-bottom: 2rem;
        }

        .setup-form {
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            margin-top: 0.5rem;
            color: #666;
            font-size: 14px;
        }

        .device-info-display {
            margin-bottom: 2rem;
        }

        .info-card {
            background: rgba(102, 126, 234, 0.1);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .info-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .info-card ul {
            list-style: none;
        }

        .info-card li {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .info-card strong {
            color: #333;
        }

        .wizard-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .status-indicator {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .status-indicator.pending {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            color: #FF9800;
        }

        .status-indicator.success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .status-indicator.error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #F44336;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .api-key-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 1rem 0;
        }

        .api-key-container input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            background: #f5f5f5;
        }

        .completion-summary {
            margin-bottom: 2rem;
        }

        .summary-card {
            background: rgba(76, 175, 80, 0.1);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid rgba(76, 175, 80, 0.2);
            margin-bottom: 1.5rem;
        }

        .summary-card h3 {
            color: #4CAF50;
            margin-bottom: 1rem;
        }

        .next-steps {
            background: rgba(102, 126, 234, 0.1);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            margin-bottom: 2rem;
        }

        .next-steps h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .next-steps ol {
            padding-left: 1.5rem;
        }

        .next-steps li {
            margin-bottom: 0.5rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .wizard-container {
                padding: 1rem;
            }
            
            .wizard-header h1 {
                font-size: 2rem;
            }
            
            .wizard-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <header class="wizard-header">
            <h1>üöÄ Zip MyL Setup Wizard</h1>
            <p>Let's get you set up with SSL certificates and extension access</p>
        </header>

        <div class="wizard-progress">
            <div class="progress-step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-label">User Info</span>
            </div>
            <div class="progress-step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-label">SSL Setup</span>
            </div>
            <div class="progress-step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-label">Extension Key</span>
            </div>
            <div class="progress-step" data-step="4">
                <span class="step-number">4</span>
                <span class="step-label">Complete</span>
            </div>
        </div>

        <div class="wizard-content">
            <!-- Step 1: User Information -->
            <div class="wizard-step active" id="step-1">
                <h2>Welcome! Let's get started</h2>
                <p>Please provide your information so we can set up your SSL certificate and extension access.</p>
                
                <form class="setup-form">
                    <div class="form-group">
                        <label for="userInitials">Your Initials (or email)</label>
                        <input type="text" id="userInitials" name="userInitials" placeholder="e.g., JD or john@example.com" required>
                        <small>This is how we'll identify your setup</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="deviceName">Device Name</label>
                        <input type="text" id="deviceName" name="deviceName" placeholder="e.g., My Laptop" required>
                        <small>What would you like to call this device?</small>
                    </div>
                </form>
                
                <div class="device-info-display">
                    <div class="info-card">
                        <h3>üîë Your Device Information</h3>
                        <ul>
                            <li><strong>Device ID:</strong> <span id="display-device-id">Loading...</span></li>
                            <li><strong>SSL Domain:</strong> <span id="display-ssl-domain">Loading...</span></li>
                            <li><strong>Certificate:</strong> Wildcard *.myl.zip (Automatic)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="wizard-actions">
                    <button type="button" class="btn btn-primary" onclick="nextStep()">Continue</button>
                </div>
            </div>

            <!-- Step 2: SSL Certificate Setup -->
            <div class="wizard-step" id="step-2">
                <h2>SSL Certificate Setup</h2>
                <p>We'll provision an SSL certificate for your domain to ensure secure connections.</p>
                
                <div class="ssl-setup-info">
                    <div class="info-card">
                        <h3>üîí SSL Certificate Details</h3>
                        <ul>
                            <li><strong>Device Domain:</strong> <span id="ssl-domain"></span></li>
                            <li><strong>Certificate Type:</strong> Wildcard *.myl.zip</li>
                            <li><strong>Provider:</strong> Google Cloud (Automatic)</li>
                            <li><strong>Auto-renewal:</strong> Enabled</li>
                            <li><strong>Security:</strong> Military-grade encryption</li>
                        </ul>
                    </div>
                </div>
                
                <div class="ssl-provision-status">
                    <div class="status-indicator" id="ssl-status">
                        <span class="status-text">Ready to provision</span>
                        <div class="spinner" id="ssl-spinner" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="wizard-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn btn-primary" onclick="provisionSSL()">Provision SSL Certificate</button>
                </div>
            </div>

            <!-- Step 3: Extension API Key Generation -->
            <div class="wizard-step" id="step-3">
                <h2>Extension API Key Generation</h2>
                <p>Now we'll generate an API key for your Chrome extension to access the backend securely.</p>
                
                <div class="extension-setup-info">
                    <div class="info-card">
                        <h3>üîë Extension API Key Details</h3>
                        <ul>
                            <li><strong>Device ID:</strong> <span id="extension-device-id"></span></li>
                            <li><strong>Permissions:</strong> SSL Read, Device Read</li>
                            <li><strong>Rate Limit:</strong> 1000 requests/hour</li>
                            <li><strong>Expiration:</strong> 30 days</li>
                        </ul>
                    </div>
                </div>
                
                <div class="api-key-status">
                    <div class="status-indicator" id="api-key-status">
                        <span class="status-text">Ready to generate</span>
                        <div class="spinner" id="api-key-spinner" style="display: none;"></div>
                    </div>
                </div>
                
                <div class="wizard-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button type="button" class="btn btn-primary" onclick="generateApiKey()">Generate API Key</button>
                </div>
            </div>

            <!-- Step 4: Setup Complete -->
            <div class="wizard-step" id="step-4">
                <h2>üéâ Setup Complete!</h2>
                <p>Your SSL certificate and extension API key have been successfully configured.</p>
                
                <div class="completion-summary">
                    <div class="summary-card">
                        <h3>‚úÖ What's Been Set Up</h3>
                        <ul>
                            <li>SSL certificate for <span id="summary-domain"></span> (UUID subdomain)</li>
                            <li>Extension API key generated</li>
                            <li>Device registered and configured</li>
                            <li>Secure access enabled</li>
                            <li>Wildcard certificate coverage</li>
                        </ul>
                    </div>
                    
                    <div class="api-key-display">
                        <h3>üîë Your Extension API Key</h3>
                        <div class="api-key-container">
                            <input type="text" id="generated-api-key" readonly>
                            <button type="button" class="btn btn-secondary" onclick="copyApiKey()">Copy</button>
                        </div>
                        <small>Store this key securely - it won't be shown again</small>
                    </div>
                </div>
                
                <div class="next-steps">
                    <h3>üìã Next Steps</h3>
                    <ol>
                        <li>Install the Chrome extension</li>
                        <li>Use the API key to configure the extension</li>
                        <li>Start using your secure SSL-enabled setup</li>
                    </ol>
                </div>
                
                <div class="wizard-actions">
                    <button type="button" class="btn btn-primary" onclick="downloadConfig()">Download Configuration</button>
                    <button type="button" class="btn btn-secondary" onclick="restartWizard()">Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Setup Wizard JavaScript
         * Handles the multi-step setup process for SSL certificates and extension configuration
         */

        let currentStep = 1;
        let setupData = {
            userInitials: '',
            deviceName: '',
            deviceId: null,
            uuidSubdomain: null
        };

        // Initialize wizard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç [DEBUG] Setup wizard initializing...');
            console.log('üîç [DEBUG] Current URL:', window.location.href);
            
            // Get device ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            setupData.deviceId = urlParams.get('deviceId');
            
            console.log('üîç [DEBUG] URL params:', window.location.search);
            console.log('üîç [DEBUG] Device ID from URL:', setupData.deviceId);
            
            if (setupData.deviceId) {
                console.log('‚úÖ [DEBUG] Device ID found, updating display...');
                // Generate proper UUID subdomain
                setupData.uuidSubdomain = generateUUID() + '.myl.zip';
                
                // Update display elements
                const elements = {
                    'extension-device-id': setupData.deviceId,
                    'display-device-id': setupData.deviceId,
                    'display-ssl-domain': setupData.uuidSubdomain,
                    'ssl-domain': setupData.uuidSubdomain,
                    'summary-domain': setupData.uuidSubdomain
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        console.log(`‚úÖ [DEBUG] Updated ${id}: ${value}`);
                    } else {
                        console.log(`‚ùå [DEBUG] Element not found: ${id}`);
                    }
                });
            } else {
                console.log('‚ö†Ô∏è [DEBUG] No device ID found, adding manual input...');
                // Try to get device ID from Chrome extension
                setupExtensionCommunication();
                
                // Add manual device ID input option
                addManualDeviceIdInput();
            }
            
            updateProgress();
        });

        // Navigation functions
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < 4) {
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                    
                    // Auto-trigger background processes
                    if (currentStep === 2) {
                        console.log('üîÑ [AUTO] Auto-triggering SSL provisioning...');
                        provisionSSL();
                    } else if (currentStep === 3) {
                        console.log('üîÑ [AUTO] Auto-triggering API key generation...');
                        generateApiKey();
                    }
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgress();
            }
        }

        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show current step
            document.getElementById(`step-${stepNumber}`).classList.add('active');
        }

        function updateProgress() {
            // Update progress indicators
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < currentStep) {
                    step.classList.add('completed');
                }
            });
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    return validateUserInfo();
                case 2:
                    return true; // SSL setup validation handled in provisionSSL()
                case 3:
                    return true; // API key generation validation handled in generateApiKey()
                default:
                    return true;
            }
        }

        function validateUserInfo() {
            console.log('üîç [DEBUG] Validating user info...');
            console.log('üîç [DEBUG] setupData.deviceId:', setupData.deviceId);
            
            const userInitials = document.getElementById('userInitials').value.trim();
            const deviceName = document.getElementById('deviceName').value.trim();
            
            console.log('üîç [DEBUG] userInitials:', userInitials);
            console.log('üîç [DEBUG] deviceName:', deviceName);
            
            if (!userInitials) {
                console.log('‚ùå [DEBUG] No user initials');
                showError('Please enter your initials or email');
                return false;
            }
            
            if (!deviceName) {
                console.log('‚ùå [DEBUG] No device name');
                showError('Please enter a device name');
                return false;
            }
            
            if (!setupData.deviceId) {
                console.log('‚ùå [DEBUG] No device ID');
                showError('Device ID not found. Please enter your device ID manually or use the Chrome extension to access this page.');
                return false;
            }
            
            console.log('‚úÖ [DEBUG] All validation passed');
            // Store data
            setupData.userInitials = userInitials;
            setupData.deviceName = deviceName;
            
            return true;
        }

        // SSL Provisioning - Background Process
        async function provisionSSL() {
            console.log('üîí [SSL] Starting SSL certificate provisioning...');
            console.log('üîí [SSL] Device ID:', setupData.deviceId);
            console.log('üîí [SSL] UUID Subdomain:', setupData.uuidSubdomain);
            console.log('üîí [SSL] User Initials:', setupData.userInitials);
            console.log('üîí [SSL] Device Name:', setupData.deviceName);
            
            const statusEl = document.getElementById('ssl-status');
            const spinnerEl = document.getElementById('ssl-spinner');
            const statusTextEl = statusEl.querySelector('.status-text');
            
            // Show loading state
            statusEl.className = 'status-indicator pending';
            statusTextEl.textContent = 'Provisioning SSL certificate...';
            spinnerEl.style.display = 'inline-block';
            
            try {
                console.log('üîí [SSL] Making API request to https://api.myl.zip/api/v1/ssl/setup-wizard/provision');
                const response = await fetch('https://api.myl.zip/api/v1/ssl/setup-wizard/provision', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId: setupData.deviceId,
                        uuidSubdomain: setupData.uuidSubdomain,
                        userInitials: setupData.userInitials,
                        deviceName: setupData.deviceName
                    })
                });
                
                console.log('üîí [SSL] Response status:', response.status);
                console.log('üîí [SSL] Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üîí [SSL] Response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ [SSL] SSL certificate provisioned successfully!');
                        statusEl.className = 'status-indicator success';
                        statusTextEl.textContent = 'SSL certificate provisioned successfully!';
                        
                        // Auto-advance to next step after 2 seconds
                        setTimeout(() => {
                            console.log('üîÑ [AUTO] Auto-advancing to API key generation...');
                            nextStep();
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'SSL provisioning failed');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('üîí [SSL] HTTP Error Response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå [SSL] SSL provisioning error:', error);
                statusEl.className = 'status-indicator error';
                if (error.message.includes('404')) {
                    statusTextEl.textContent = 'Backend service is updating. Please try again in a few minutes.';
                } else {
                    statusTextEl.textContent = `Error: ${error.message}`;
                }
                
                // Show error but allow manual retry
                console.log('‚ö†Ô∏è [SSL] SSL provisioning failed, user can retry manually');
            } finally {
                spinnerEl.style.display = 'none';
            }
        }

        // API Key Generation - Background Process
        async function generateApiKey() {
            console.log('üîë [API] Starting API key generation...');
            console.log('üîë [API] Device ID:', setupData.deviceId);
            console.log('üîë [API] Device Name:', setupData.deviceName);
            console.log('üîë [API] User Initials:', setupData.userInitials);
            
            const statusEl = document.getElementById('api-key-status');
            const spinnerEl = document.getElementById('api-key-spinner');
            const statusTextEl = statusEl.querySelector('.status-text');
            
            // Show loading state
            statusEl.className = 'status-indicator pending';
            statusTextEl.textContent = 'Generating API key...';
            spinnerEl.style.display = 'inline-block';
            
            try {
                console.log('üîë [API] Making API request to https://api.myl.zip/api/v1/ssl/setup-wizard/generate-key');
                const response = await fetch('https://api.myl.zip/api/v1/ssl/setup-wizard/generate-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId: setupData.deviceId,
                        deviceName: setupData.deviceName,
                        userInitials: setupData.userInitials
                    })
                });
                
                console.log('üîë [API] Response status:', response.status);
                console.log('üîë [API] Response headers:', Object.fromEntries(response.headers.entries()));
                
                                 if (response.ok) {
                     const data = await response.json();
                     console.log('üîë [API] Response data:', data);
                     console.log('üîë [DEBUG] data.success:', data.success);
                     console.log('üîë [DEBUG] data.data:', data.data);
                     console.log('üîë [DEBUG] data.data.data:', data.data?.data);
                     console.log('üîë [DEBUG] data.data.data.apiKey:', data.data?.data?.apiKey);
                     
                     if (data.success && data.data && data.data.data && data.data.data.apiKey) {
                        console.log('‚úÖ [API] API key generated successfully!');
                        statusEl.className = 'status-indicator success';
                        statusTextEl.textContent = 'API key generated successfully!';
                        
                        // Store API key for display
                        setupData.apiKey = data.data.data.apiKey;
                        console.log('üîë [API] API key stored:', setupData.apiKey.substring(0, 10) + '...');
                        
                        // Auto-advance to completion step after 2 seconds
                        setTimeout(() => {
                            console.log('üîÑ [AUTO] Auto-advancing to completion step...');
                            nextStep();
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'API key generation failed');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('üîë [API] HTTP Error Response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå [API] API key generation error:', error);
                statusEl.className = 'status-indicator error';
                if (error.message.includes('404')) {
                    statusTextEl.textContent = 'Backend service is updating. Please try again in a few minutes.';
                } else {
                    statusTextEl.textContent = `Error: ${error.message}`;
                }
                
                // Show error but allow manual retry
                console.log('‚ö†Ô∏è [API] API key generation failed, user can retry manually');
            } finally {
                spinnerEl.style.display = 'none';
            }
        }

        // Copy API Key
        function copyApiKey() {
            const apiKeyInput = document.getElementById('generated-api-key');
            if (setupData.apiKey) {
                apiKeyInput.value = setupData.apiKey;
                apiKeyInput.select();
                document.execCommand('copy');
                
                // Show feedback
                const copyBtn = document.querySelector('.api-key-container .btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.style.background = '#4CAF50';
                copyBtn.style.color = 'white';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                    copyBtn.style.color = '';
                }, 2000);
            }
        }

        // Download Configuration
        function downloadConfig() {
            const config = {
                deviceId: setupData.deviceId,
                apiKey: setupData.apiKey,
                uuidSubdomain: setupData.uuidSubdomain,
                deviceName: setupData.deviceName,
                userInitials: setupData.userInitials,
                setupDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mylzip-config-${setupData.deviceId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Restart Wizard
        function restartWizard() {
            if (confirm('Are you sure you want to start over? All progress will be lost.')) {
                currentStep = 1;
                setupData = {
                    userInitials: '',
                    deviceName: '',
                    deviceId: setupData.deviceId, // Keep device ID
                    uuidSubdomain: setupData.uuidSubdomain // Keep UUID subdomain
                };
                
                // Clear form fields
                document.getElementById('userInitials').value = '';
                document.getElementById('deviceName').value = '';
                
                showStep(1);
                updateProgress();
            }
        }

        // Utility functions
        function showError(message) {
            // Create a simple error notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function showSuccess(message) {
            // Create a simple success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Extension communication
        function setupExtensionCommunication() {
            // Listen for extension events
            document.addEventListener('mylzip-device-ready', (event) => {
                console.log('Extension device ready:', event.detail);
                if (event.detail.deviceId && !setupData.deviceId) {
                    setupData.deviceId = event.detail.deviceId;
                    setupData.uuidSubdomain = generateUUID() + '.myl.zip';
                    
                    // Update display elements
                    document.getElementById('extension-device-id').textContent = setupData.deviceId;
                    document.getElementById('display-device-id').textContent = setupData.deviceId;
                    document.getElementById('display-ssl-domain').textContent = setupData.uuidSubdomain;
                    document.getElementById('ssl-domain').textContent = setupData.uuidSubdomain;
                    document.getElementById('summary-domain').textContent = setupData.uuidSubdomain;
                    
                    // Hide manual input
                    hideManualDeviceIdInput();
                }
            });
            
            // Send device info to extension if available
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                window.postMessage({
                    type: 'mylzip-portal-request',
                    action: 'get-device-info'
                }, '*');
            }
        }

        // Add manual device ID input
        function addManualDeviceIdInput() {
            const deviceInfoCard = document.querySelector('.device-info-display .info-card');
            if (deviceInfoCard) {
                const manualInputHtml = `
                    <div class="manual-device-input" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; color: #fff;">üîë Enter Device ID Manually</h4>
                        <p style="margin: 0 0 10px 0; color: rgba(255,255,255,0.8); font-size: 14px;">
                            If you have your device ID from the Chrome extension, enter it here:
                        </p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="manualDeviceId" placeholder="e.g., mylzip_auth_1234567890_abc123" 
                                   style="flex: 1; padding: 8px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: rgba(255,255,255,0.1); color: #fff;">
                            <button onclick="setManualDeviceId()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Set Device ID
                            </button>
                        </div>
                    </div>
                `;
                deviceInfoCard.insertAdjacentHTML('beforeend', manualInputHtml);
            }
        }

        // Hide manual device ID input
        function hideManualDeviceIdInput() {
            const manualInput = document.querySelector('.manual-device-input');
            if (manualInput) {
                manualInput.style.display = 'none';
            }
        }

        // Set manual device ID
        function setManualDeviceId() {
            const manualInput = document.getElementById('manualDeviceId');
            const deviceId = manualInput.value.trim();
            
            if (deviceId) {
                setupData.deviceId = deviceId;
                setupData.uuidSubdomain = generateUUID() + '.myl.zip';
                
                // Update display elements
                document.getElementById('extension-device-id').textContent = setupData.deviceId;
                document.getElementById('display-device-id').textContent = setupData.deviceId;
                document.getElementById('display-ssl-domain').textContent = setupData.uuidSubdomain;
                document.getElementById('ssl-domain').textContent = setupData.uuidSubdomain;
                document.getElementById('summary-domain').textContent = setupData.uuidSubdomain;
                
                // Hide manual input
                hideManualDeviceIdInput();
                
                showSuccess('Device ID set successfully!');
            } else {
                showError('Please enter a valid device ID');
            }
        }

        // UUID Generation Function
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Initialize extension communication
        setupExtensionCommunication();
        
        // Console info for developers
        console.log('üöÄ [SETUP] MyL.Zip Setup Wizard Loaded');
        console.log('üìã [INFO] This is the setup wizard for myl.zip');
        console.log('üîó [AUTH] Auth Page: https://myl.zip/auth.html');
        console.log('üè† [HOME] Home Page: https://myl.zip');
    </script>
</body>
</html>
